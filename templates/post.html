{% extends "base.html" %}
{% block main %}

<!-- 3-column page grid: left margin · main text · right margin -->
<div class="page-grid">

  {# ---- Page-level watermark illustrations (decorative; absolute) ---- #}
  {% if post.margin_images %}
    {% for img in post.margin_images %}
      <aside class="watermark-{{ img.side|e }}" style="--wm-top: {{ img.top or '0' }};">
        <img src="{{ base }}/static/{{ img.src|e }}" alt="{{ img.alt or '' }}">
      </aside>
    {% endfor %}
  {% endif %}

  {# ---- Title & meta ---- #}
  <header class="article header-span-2">
    <h1>{{ post.title }}</h1>
    <p class="muted">
      {{ post.date }}{% if post.tags %} · {{ post.tags|join(", ") }}{% endif %}
    </p>
  </header>

  {# ---- Sections ---- #}
  {% for s in post.sections %}

    {# Plain paragraph text #}
    {% if s.type == "p" %}
      <p class="article">{{ s.text }}</p>

    {# HTML content (Markdown rendered in build.py) #}
    {% elif s.type == "html" %}
      <div class="article">{{ s.html | safe }}</div>

    {# Expander with HTML content (Markdown) #}
    {% elif s.type == "expander_html" %}
      {% set id = "exp-" ~ loop.index %}
      <button class="expander article" aria-expanded="false" aria-controls="{{ id }}">
        <span class="chevron" aria-hidden="true">▸</span>
        <span class="sr-only">{{ s.label or "Show more" }}</span>
      </button>
      <div id="{{ id }}" class="expando article" hidden>
        {{ s.html | safe }}
      </div>

    {# Back-compat: expander with plain text #}
    {% elif s.type == "expander" %}
      {% set id = "exp-" ~ loop.index %}
      <button class="expander article" aria-expanded="false" aria-controls="{{ id }}">
        <span class="chevron" aria-hidden="true">▸</span>
        <span class="sr-only">{{ s.label or "Show more" }}</span>
      </button>
      <div id="{{ id }}" class="expando article" hidden>
        <p>{{ s.content }}</p>
      </div>
    {% endif %}

    {# ---- Per-section margin images (left/right) ---- #}
    {% if s.left_margin_image %}
      <aside class="marginalia marginalia-left">
        {% if s.left_margin_caption %}
          <div class="marginalia--box">{{ s.left_margin_caption }}</div>
        {% endif %}
        <img src="{{ base }}/static/{{ s.left_margin_image|e }}" alt="{{ s.left_margin_alt or '' }}">
      </aside>
    {% endif %}

    {% if s.right_margin_image %}
      <aside class="marginalia marginalia-right">
        {% if s.right_margin_caption %}
          <div class="marginalia--box">{{ s.right_margin_caption }}</div>
        {% endif %}
        <img src="{{ base }}/static/{{ s.right_margin_image|e }}" alt="{{ s.right_margin_alt or '' }}">
      </aside>
    {% endif %}

    {# ---- Per-section margin notes as HTML (optional) ---- #}
    {% if s.note_html %}
      <aside class="marginalia marginalia-right">
        <div class="marginalia--box">{{ s.note_html | safe }}</div>
      </aside>
    {% endif %}

  {% endfor %}
</div>

{% endblock %}
