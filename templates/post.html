{% extends "base.html" %}
{% block main %}

{# =========================================
   Optional hero background wrapper
   ========================================= #}
{% if post.hero_background %}
  <div class="hero-bg hero-fade"
       style="--hero-img: url('{{ base }}/static/{{ post.hero_background.src | e }}');
              --hero-opacity: {{ post.hero_background.opacity or '0.22' }};
              --hero-pos: {{ (post.hero_background.position or 'center top') | e }};">
{% endif %}

  {# =========================================
     Page grid for title + page-level watermarks
     ========================================= #}
  <div class="page-grid">

    {# ---- Page-level watermark illustrations (decorative; absolute) ---- #}
    {% if post.margin_images %}
      {% for img in post.margin_images %}
        <aside class="watermark-{{ img.side|e }}" style="--wm-top: {{ img.top or '0' }};">
          <img src="{{ base }}/static/{{ img.src|e }}" alt="{{ img.alt or '' }}">
        </aside>
      {% endfor %}
    {% endif %}

    {# ---- Title & meta ---- #}
    <header class="article header-span-2">
      <h1>{{ post.title }}</h1>
      <p class="muted">
        {{ post.date }}{% if post.tags %} · {{ post.tags|join(", ") }}{% endif %}
      </p>
    </header>
  </div>

  {# =========================================
     Sections: each inside its own 3-col row grid
     ========================================= #}
  {% for s in post.sections %}
    <section class="row-grid">

      {# ---- Left margin (per-section image/note) ---- #}
      {% if s.left_margin_image %}
        <aside class="marginalia row-left">
          {% if s.left_margin_caption %}
            <div class="marginalia--box">{{ s.left_margin_caption }}</div>
          {% endif %}
          <img src="{{ base }}/static/{{ s.left_margin_image|e }}" alt="{{ s.left_margin_alt or '' }}">
        </aside>
      {% elif s.left_note_html %}
        <aside class="marginalia row-left">
          <div class="marginalia--box">{{ s.left_note_html | safe }}</div>
        </aside>
      {% elif s.left_note %}
        <aside class="marginalia row-left">
          <div class="marginalia--box">{{ s.left_note }}</div>
        </aside>
      {% endif %}

      {# ---- Main column: the section content ---- #}
      {% if s.type == "p" %}
        <p class="row-main">{{ s.text }}</p>

      {% elif s.type == "html" %}
        <div class="row-main">{{ s.html | safe }}</div>

      {% elif s.type == "expander_html" %}
        {% set id = "exp-" ~ loop.index %}
        <div class="row-main">
          <button class="expander" aria-expanded="false" aria-controls="{{ id }}">
            <span class="chevron" aria-hidden="true">▸</span>
            <span class="sr-only">{{ s.label or "Show more" }}</span>
          </button>
          <div id="{{ id }}" class="expando" hidden>
            {{ s.html | safe }}
          </div>
        </div>

      {% elif s.type == "expander" %}
        {% set id = "exp-" ~ loop.index %}
        <div class="row-main">
          <button class="expander" aria-expanded="false" aria-controls="{{ id }}">
            <span class="chevron" aria-hidden="true">▸</span>
            <span class="sr-only">{{ s.label or "Show more" }}</span>
          </button>
          <div id="{{ id }}" class="expando" hidden>
            <p>{{ s.content }}</p>
          </div>
        </div>
      {% endif %}

      {# ---- Right margin (per-section image/note) ---- #}
      {% if s.right_margin_image %}
        <aside class="marginalia row-right">
          {% if s.right_margin_caption %}
            <div class="marginalia--box">{{ s.right_margin_caption }}</div>
          {% endif %}
          <img src="{{ base }}/static/{{ s.right_margin_image|e }}" alt="{{ s.right_margin_alt or '' }}">
        </aside>
      {% elif s.right_note_html %}
        <aside class="marginalia row-right">
          <div class="marginalia--box">{{ s.right_note_html | safe }}</div>
        </aside>
      {% elif s.right_note %}
        <aside class="marginalia row-right">
          <div class="marginalia--box">{{ s.right_note }}</div>
        </aside>
      {% endif %}

    </section>
  {% endfor %}

{% if post.hero_background %}
  </div>  {# close .hero-bg #}
{% endif %}

{% endblock %}
