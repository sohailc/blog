{% extends "base.html" %}
{% block main %}

{# =========================================
   Title area
   - If hero_background is present, show a banner with the title.
   - Otherwise, render the title in a normal page grid.
   ========================================= #}
{% if post.hero_background %}
  <div class="hero-bg hero-fade"
       style="--hero-img: url('{{ base }}/static/{{ post.hero_background.src | e }}');
              --hero-opacity: {{ post.hero_background.opacity or '0.22' }};
              --hero-pos: {{ (post.hero_background.position or 'left center') | e }};
              --hero-ar: {{ post.hero_background.aspect_ratio or '3/1' }};">

    <div class="hero-content">
      <div class="page-grid">

        {% if post.margin_images %}
          {% for img in post.margin_images %}
            <aside class="watermark-{{ img.side|e }}" style="--wm-top: {{ img.top or '0' }};">
              <img src="{{ base }}/static/{{ img.src|e }}" alt="{{ img.alt or '' }}">
            </aside>
          {% endfor %}
        {% endif %}

        <header class="article header-span-2">
          <h1>{{ post.title }}</h1>
          <p class="muted">
            {{ post.date }}{% if post.tags %} · {{ post.tags|join(", ") }}{% endif %}
          </p>
        </header>

      </div>
    </div> <!-- /.hero-content -->

  </div> <!-- /.hero-bg -->
{% else %}
  <div class="page-grid">
    {% if post.margin_images %}
      {% for img in post.margin_images %}
        <aside class="watermark-{{ img.side|e }}" style="--wm-top: {{ img.top or '0' }};">
          <img src="{{ base }}/static/{{ img.src|e }}" alt="{{ img.alt or '' }}">
        </aside>
      {% endfor %}
    {% endif %}

    <header class="article header-span-2">
      <h1>{{ post.title }}</h1>
      <p class="muted">
        {{ post.date }}{% if post.tags %} · {{ post.tags|join(", ") }}{% endif %}
      </p>
    </header>
  </div>
{% endif %}

{# =========================================
   Optional Table of Contents
   Build from sections that include a "title".
   Disable by setting "toc": false in post.json
   ========================================= #}
{% set show_toc = (post.toc is not defined) or (post.toc != false) %}
{% if show_toc %}
  {% set toc_items = [] %}
  {% for s in post.sections if s.title %}
    {% set raw = s.title %}
    {% set id = (raw|lower
                  |replace("’","")
                  |replace("'","")
                  |replace(",","")
                  |replace(".","")
                  |replace(":","")
                  |replace(";","")
                  |replace("&","and")
                  |replace(" ","-")) %}
    {% set _ = toc_items.append({'id': id, 'title': s.title}) %}
  {% endfor %}
  {% if toc_items|length > 0 %}
    <nav class="page-grid">
      <aside class="article header-span-2 toc">
        <strong>Contents</strong>
        <ul>
          {% for item in toc_items %}
            <li><a href="#{{ item.id }}">{{ item.title }}</a></li>
          {% endfor %}
        </ul>
      </aside>
    </nav>
  {% endif %}
{% endif %}

{# =========================================
   Sections: each inside its own 3-col row grid
   Each "chapter" is just a section with a title + markdown file.
   ========================================= #}
{% for s in post.sections %}
  {# Build a stable anchor id for this section if it has a title #}
  {% if s.title %}
    {% set sec_id = (s.title|lower
                      |replace("’","")
                      |replace("'","")
                      |replace(",","")
                      |replace(".","")
                      |replace(":","")
                      |replace(";","")
                      |replace("&","and")
                      |replace(" ","-")) %}
  {% else %}
    {% set sec_id = "section-" ~ loop.index %}
  {% endif %}

  <section class="row-grid" {% if s.title %}id="{{ sec_id }}"{% endif %}>

    {# ---- Left margin (per-section image/note) ---- #}
    {% if s.left_margin_image %}
      <aside class="marginalia row-left">
        {% if s.left_margin_caption %}
          <div class="marginalia--box">{{ s.left_margin_caption }}</div>
        {% endif %}
        <img src="{{ base }}/static/{{ s.left_margin_image|e }}" alt="{{ s.left_margin_alt or '' }}">
      </aside>
    {% elif s.left_note_html %}
      <aside class="marginalia row-left">
        <div class="marginalia--box">{{ s.left_note_html | safe }}</div>
      </aside>
    {% elif s.left_note %}
      <aside class="marginalia row-left">
        <div class="marginalia--box">{{ s.left_note }}</div>
      </aside>
    {% endif %}

    {# ---- Main column: the section content ---- #}
    <div class="row-main">
      {% if s.title %}
        <h2 class="chapter-title">{{ s.title }}</h2>
      {% endif %}

      {% if s.type == "p" %}
        <p>{{ s.text }}</p>

      {% elif s.type == "html" %}
        {{ s.html | safe }}

      {% elif s.type == "expander_html" %}
        {% set id = "exp-" ~ loop.index %}
        <button class="expander" aria-expanded="false" aria-controls="{{ id }}">
          <span class="chevron" aria-hidden="true">▸</span>
          <span class="sr-only">{{ s.label or "Show more" }}</span>
        </button>
        <div id="{{ id }}" class="expando" hidden>
          {{ s.html | safe }}
        </div>

      {% elif s.type == "expander" %}
        {% set id = "exp-" ~ loop.index %}
        <button class="expander" aria-expanded="false" aria-controls="{{ id }}">
          <span class="chevron" aria-hidden="true">▸</span>
          <span class="sr-only">{{ s.label or "Show more" }}</span>
        </button>
        <div id="{{ id }}" class="expando" hidden>
          <p>{{ s.content }}</p>
        </div>
      {% endif %}
    </div>

    {# ---- Right margin (per-section image/note) ---- #}
    {% if s.right_margin_image %}
      <aside class="marginalia row-right">
        {% if s.right_margin_caption %}
          <div class="marginalia--box">{{ s.right_margin_caption }}</div>
        {% endif %}
        <img src="{{ base }}/static/{{ s.right_margin_image|e }}" alt="{{ s.right_margin_alt or '' }}">
      </aside>
    {% elif s.right_note_html %}
      <aside class="marginalia row-right">
        <div class="marginalia--box">{{ s.right_note_html | safe }}</div>
      </aside>
    {% elif s.right_note %}
      <aside class="marginalia row-right">
        <div class="marginalia--box">{{ s.right_note }}</div>
      </aside>
    {% endif %}

  </section>
{% endfor %}

{# =========================================
   Previous / Next navigation (optional)
   ========================================= #}
{% set prev_is_obj = post.prev is mapping %}
{% set next_is_obj = post.next is mapping %}
{% set prev_slug = (post.prev.slug if prev_is_obj else post.prev) if post.prev else None %}
{% set next_slug = (post.next.slug if next_is_obj else post.next) if post.next else None %}
{% set prev_label = (post.prev.label if prev_is_obj and post.prev.label else "← Previous") if prev_slug else None %}
{% set next_label = (post.next.label if next_is_obj and post.next.label else "Next →") if next_slug else None %}

{% if prev_slug or next_slug %}
  <nav class="page-grid" aria-label="Post navigation">
    <div class="article header-span-2 post-nav">
      <div class="post-nav-left">
        {% if prev_slug %}
          <a href="{{ base }}/posts/{{ prev_slug }}/">{{ prev_label }}</a>
        {% endif %}
      </div>
      <div class="post-nav-right">
        {% if next_slug %}
          <a href="{{ base }}/posts/{{ next_slug }}/">{{ next_label }}</a>
        {% endif %}
      </div>
    </div>
  </nav>
{% endif %}

{% endblock %}
